<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grade Goal Calculator — Pro</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#0b0f14; --bg1:#101720;
      --glass:rgba(20,24,28,.75); --border:rgba(255,255,255,.12);
      --brand:#8fcbff; --brand-2:#4ba3ff; --brand-3:#83ffe9;
      --text-muted:#a8b5c3;
      --success:#37d67a; --warning:#f0ad4e; --danger:#d9534f; --info:#5bc0de;

      /* ✨ animation tuning */
      --dur-fast:.25s; --dur:.45s; --dur-slow:.8s; --spring:cubic-bezier(.2,.8,.2,1);
    }

    /* ======= BACKGROUND ======= */
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(143,203,255,.12), transparent 60%),
        radial-gradient(900px 500px  at 110% 20%, rgba(143,203,255,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      background-attachment:fixed;
      font-family:'Segoe UI', system-ui, sans-serif;
      overflow-x:hidden;
    }
    /* ✨ Animated aurora veil */
    .aurora{
      position:fixed; inset:-10vmax;
      pointer-events:none; z-index:-1;
      filter:blur(30px) saturate(120%);
      opacity:.32; mix-blend-mode:screen;
    }
    .aurora::before, .aurora::after{
      content:""; position:absolute; inset:0;
      background:
        radial-gradient(60vmax 40vmax at 20% 10%, rgba(75,163,255,.45), transparent 60%),
        radial-gradient(50vmax 30vmax at 80% 30%, rgba(131,255,233,.35), transparent 60%),
        radial-gradient(45vmax 28vmax at 50% 80%, rgba(143,203,255,.35), transparent 60%);
      animation: drift 20s linear infinite;
    }
    .aurora::after{ animation: drift 28s linear infinite reverse; opacity:.8; }
    @keyframes drift{ from{transform:translateY(0) rotate(0)} to{transform:translateY(-4%) rotate(1turn)} }

    .brand{
      background:linear-gradient(90deg,#b8e1ff,#67b6ff,#83ffe9,#b8e1ff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size:200% 200%; animation:shine 7s linear infinite, floaty 6s ease-in-out infinite;
      font-weight:800; letter-spacing:-.5px;
    }
    @keyframes shine{ 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }
    @keyframes floaty{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }

    .glass{
      background:var(--glass); border:1px solid var(--border); backdrop-filter:blur(12px);
      box-shadow:0 15px 35px rgba(0,0,0,.25); border-radius:1.25rem;
      transition:transform var(--dur), box-shadow var(--dur);
      transform-style:preserve-3d;
    }
    .glass:hover{ transform:translateY(-2px); box-shadow:0 20px 40px rgba(0,0,0,.32); }
    /* ✨ subtle 3D tilt on pointer move */
    .tilt{
      transform: perspective(1000px) rotateX(var(--rx,0)) rotateY(var(--ry,0)) translateY(var(--ty,0));
      transition: transform .12s linear;
    }

    .muted{ color:var(--text-muted); }

    /* Inputs & dropdowns */
    .form-control, .form-select{
      border-radius:.75rem; border:1px solid var(--border);
      background-color:rgba(255,255,255,.08); color:#e8eef6;
      padding:.75rem 1rem; transition:var(--dur);
      font-size:.95rem;
    }
    .form-control:focus, .form-select:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 .25rem rgba(143,203,255,.15);
      background-color:rgba(255,255,255,.12);
    }
    /* Dark dropdown menu styling */
    .form-select option, .form-select optgroup{ background-color:#1f2428; color:#e8eef6; }

    .progress{ height:.75rem; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden }
    .progress-bar{ background:linear-gradient(90deg, var(--brand-2), var(--brand)); border-radius:999px; transition:width var(--dur) var(--spring); }

    .result-big{ font-size:clamp(2rem,4.5vw,3.25rem); font-weight:800; letter-spacing:.5px; }
    .status-badge{ font-weight:600; font-size:.85rem; transition:transform var(--dur) var(--spring); }
    .status-badge.pop{ transform:scale(1.06); }
    .chart-wrap{ position:relative; width:100%; min-height:260px; }
    .chip{ background:rgba(255,255,255,.08); border:1px solid var(--border); transition:var(--dur-fast); }
    .chip:hover{ background:rgba(255,255,255,.12); transform:translateY(-1px); }
    #resultCard.inactive{ opacity:.7; filter:grayscale(.5); pointer-events:none; }

    .grade-indicator{
      display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px;
      border-radius:50%; background:rgba(255,255,255,.1); border:1px solid var(--border);
      font-weight:700; font-size:.9rem;
    }

    /* OVERALL card */
    .overall-card{
      position:relative;
      background:
        radial-gradient(120% 120% at 0% 0%, rgba(143,203,255,.18), rgba(143,203,255,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:1rem; padding:1rem 1.25rem;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .overall-card::after{
      /* ✨ animated corner sheen */
      content:""; position:absolute; top:-100%; left:-50%; width:200%; height:300%;
      background:conic-gradient(from var(--angle,0turn), transparent 0 70%, rgba(143,203,255,.12), transparent 90%);
      animation:spin 12s linear infinite;
    }
    @keyframes spin{ to{ --angle:1turn; } }
    .overall-number{ font-size:clamp(2.2rem,5vw,3.5rem); font-weight:900; letter-spacing:.5px; line-height:1; }
    .overall-sub{ font-size:.9rem; color:var(--text-muted); }
    .overall-badge{ font-weight:700; border-radius:.6rem; padding:.35rem .6rem; }
    .overall-progress{ height:.5rem; border-radius:999px; background:rgba(255,255,255,.1); overflow:hidden; }
    .overall-progress .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--brand-2), var(--brand)); transition:width var(--dur) var(--spring); }
    .grade-a{ background:#37d67a; color:#04120a; }
    .grade-b{ background:#5bc0de; color:#061018; }
    .grade-c{ background:#f0ad4e; color:#1d1102; }
    .grade-f{ background:#d9534f; color:#fff; }
    .badge.sparkle{ animation:sparkle .9s ease-out 1; }
    @keyframes sparkle{
      0%{ box-shadow:0 0 0 0 rgba(255,255,255,.0) }
      40%{ box-shadow:0 0 0 8px rgba(131,255,233,.15) }
      100%{ box-shadow:0 0 0 0 rgba(131,255,233,0) }
    }

    /* Required Final — premium card */
    .need-card{
      position:relative; border-radius:1rem; padding:1rem 1.25rem;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); box-shadow:0 10px 25px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .need-card::before{
      content:""; position:absolute; inset:-2px; border-radius:1.2rem;
      background:conic-gradient(from var(--ring,180deg), rgba(75,163,255,.25), rgba(143,203,255,.15), transparent 40%);
      filter:blur(18px); z-index:0; animation:ring 9s linear infinite;
    }
    @keyframes ring{ to{ --ring:540deg; } }
    .need-inner{ position:relative; z-index:1; }
    .need-number{ font-size:clamp(2.1rem,4.8vw,3.25rem); font-weight:900; line-height:1; transition: color var(--dur); }
    .mini-progress{ height:.4rem; border-radius:999px; background:rgba(255,255,255,.1); overflow:hidden; }
    .mini-progress .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--brand-2),var(--brand)); transition:width var(--dur) var(--spring); }
    .need-ok{ border-color:rgba(55,214,122,.8)!important; box-shadow:0 10px 30px rgba(55,214,122,.15); }
    .need-info{ border-color:rgba(91,192,222,.8)!important; box-shadow:0 10px 30px rgba(91,192,222,.15); }
    .need-warn{ border-color:rgba(240,173,78,.85)!important; box-shadow:0 10px 30px rgba(240,173,78,.15); }
    .need-bad{ border-color:rgba(217,83,79,.9)!important; box-shadow:0 10px 30px rgba(217,83,79,.15); }

    /* Scrollbar */
    ::-webkit-scrollbar{ width:8px }
    ::-webkit-scrollbar-track{ background:rgba(255,255,255,.05); border-radius:10px }
    ::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.2); border-radius:10px }
    ::-webkit-scrollbar-thumb:hover{ background:rgba(255,255,255,.3) }
    .form-control:disabled, .form-select:disabled{ background-color:rgba(255,255,255,.05); color:var(--text-muted); cursor:not-allowed; opacity:.6 }

    /* ✨ reveal-on-scroll */
    .reveal{ opacity:0; transform:translateY(12px); transition:opacity var(--dur-slow) var(--spring), transform var(--dur-slow) var(--spring); }
    .reveal.visible{ opacity:1; transform:none; }

    /* ✨ Confetti bits */
    .confetti{
      position:fixed; top:0; left:0; pointer-events:none; z-index:9999;
      width:6px; height:10px; opacity:0; transform:translate3d(var(--x,0), -10px, 0) rotate(0);
      animation: drop var(--t,1200ms) ease-out forwards;
    }
    @keyframes drop{
      5%{ opacity:1 }
      100%{ transform:translate3d(var(--x,0), var(--y,60vh), 0) rotate(var(--r,1turn)); opacity:0 }
    }

    /* ✨ weight bar over/under cue */
    .wiggle{ animation:wiggle .5s ease-in-out }
    @keyframes wiggle{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-2px)} 75%{transform:translateX(2px)} }
  </style>
</head>
<body>
  <div class="aurora"></div>

  <header class="container py-4 reveal">
    <div class="text-center">
      <h1 class="brand fw-bold mb-2">Grade Goal Calculator</h1>
      <p class="lead text-secondary">Set your <span class="text-white fw-medium">goal grade</span>, configure <span class="text-white fw-medium">weights</span>, and enter your <span class="text-white fw-medium">marks</span> for instant results.</p>
    </div>
  </header>

  <main class="container pb-5">
    <div class="row g-4 align-items-start">
      <!-- LEFT: Setup -->
      <section class="col-12 col-lg-7 reveal">
        <div class="glass tilt p-4 p-md-5 h-100">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <h2 class="h3 mb-0"><i class="bi bi-sliders2 text-info me-2"></i>Setup</h2>
          </div>

          <!-- Goal Grade -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <label class="form-label fw-medium mb-3 d-flex align-items-center">
                <i class="bi bi-bullseye me-2 text-info"></i>Target Grade
              </label>
              <select class="form-select" id="goalGrade" aria-label="Goal grade">
                <option value="A+">A+</option>
                <option value="A" selected>A</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B">B</option>
                <option value="B-">B-</option>
                <option value="C+">C+</option>
                <option value="C">C</option>
                <option value="F">F</option>
              </select>
            </div>
          </div>

          <!-- Weights -->
          <div class="row g-3 mb-2 mt-2">
            <div class="col-12 d-flex align-items-center justify-content-between flex-wrap gap-2">
              <label class="form-label fw-medium mb-0 d-flex align-items-center">
                <i class="bi bi-percent me-2 text-info"></i>Assessment Weights (%)
              </label>
              <div class="d-flex align-items-center gap-2">
                <label class="small muted mb-0">Preset:</label>
                <select class="form-select form-select-sm" id="coursePreset" aria-label="Course preset" style="min-width: 260px;">
                  <option value="" selected>Custom</option>
                  <option value="SE">Software Engineering</option>
                  <option value="DSA">Data Structure & Algorithms</option>
                  <option value="AI">Artificial Intelligence</option>
                </select>
              </div>
            </div>

            <div class="col-12 col-md-4">
              <label class="small fw-medium mb-2 d-flex align-items-center">
                <i class="bi bi-clipboard-check me-1 text-warning"></i>Midterm
              </label>
              <div class="d-flex gap-2">
                <select class="form-select" id="wMidSel" aria-label="Midterm weight preset">
                  <option value="">Select</option>
                  <option>10</option><option>20</option><option>30</option><option>40</option>
                  <option>50</option><option>60</option><option>70</option><option>80</option>
                  <option>90</option><option>100</option>
                </select>
                <input type="text" inputmode="decimal" class="form-control" id="wMid" placeholder="Type" aria-label="Midterm weight (percent)" />
              </div>
            </div>
            <div class="col-12 col-md-4">
              <label class="small fw-medium mb-2 d-flex align-items-center">
                <i class="bi bi-journal-text me-1 text-success"></i>Assignment
              </label>
              <div class="d-flex gap-2">
                <select class="form-select" id="wAssSel" aria-label="Assignment weight preset">
                  <option value="">Select</option>
                  <option>10</option><option>20</option><option>30</option><option>40</option>
                  <option>50</option><option>60</option><option>70</option><option>80</option>
                  <option>90</option><option>100</option>
                </select>
                <input type="text" inputmode="decimal" class="form-control" id="wAss" placeholder="Type" aria-label="Assignment weight (percent)" />
              </div>
            </div>
            <div class="col-12 col-md-4">
              <label class="small fw-medium mb-2 d-flex align-items-center">
                <i class="bi bi-pencil-square me-1 text-danger"></i>Final
              </label>
              <div class="d-flex gap-2">
                <select class="form-select" id="wFinSel" aria-label="Final weight preset">
                  <option value="">Select</option>
                  <option>10</option><option>20</option><option>30</option><option>40</option>
                  <option>50</option><option>60</option><option>70</option><option>80</option>
                  <option>90</option><option>100</option>
                </select>
                <input type="text" inputmode="decimal" class="form-control" id="wFin" placeholder="Type" aria-label="Final weight (percent)" />
              </div>
            </div>
          </div>

          <!-- Weight validation -->
          <div class="mt-3" id="weightValidation">
            <div class="progress mb-2">
              <div class="progress-bar" id="weightProgress" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between small">
              <span>Total weights:</span>
              <span id="weightTotal">0%</span>
            </div>
          </div>

          <hr class="border-secondary my-4">

          <!-- Marks -->
          <div class="row g-3" id="marksRow">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <label class="form-label fw-medium mb-0 d-flex align-items-center">
                <i class="bi bi-graph-up me-2 text-info"></i>Your Marks
              </label>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="marksModeToggle">
                <label class="form-check-label small muted" for="marksModeToggle">Individual marks</label>
              </div>
            </div>

            <!-- ROW 1 -->
            <div class="row g-3">
              <!-- Coursework (100%) when NOT in individual mode -->
              <div class="col-12" id="courseworkWrap">
                <div class="small fw-medium mb-1">Coursework Mark</div>
                <input type="text" inputmode="decimal" class="form-control" id="mCoursework" placeholder="Coursework mark"/>
              </div>
              <!-- Midterm + Assignment (50/50) in individual mode -->
              <div class="col-12 col-md-6 individual-marks" id="midWrap" style="display:none;">
                <div class="small fw-medium mb-1">Midterm Mark</div>
                <input type="text" inputmode="decimal" class="form-control" id="mMid" placeholder="Midterm mark"/>
              </div>
              <div class="col-12 col-md-6 individual-marks" id="assWrap" style="display:none;">
                <div class="small fw-medium mb-1">Assignment Mark</div>
                <input type="text" inputmode="decimal" class="form-control" id="mAss" placeholder="Assignment mark"/>
              </div>
            </div>

            <!-- ROW 2: Final (ALWAYS here, 100%) -->
            <div class="row g-3">
              <div class="col-12" id="finalWrap">
                <div class="small fw-medium mb-1">Final Mark</div>
                <input type="text" inputmode="decimal" class="form-control" id="mFin" placeholder="Leave empty if unknown"/>
              </div>
            </div>
          </div>
          <!-- /Marks -->
        </div>
      </section>

      <!-- RIGHT: Results -->
      <aside class="col-12 col-lg-5 reveal">
        <div class="glass tilt p-4 p-md-5" id="resultCard" aria-live="polite">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <h2 class="h3 mb-0"><i class="bi bi-graph-up-arrow text-info me-2"></i>Results</h2>
          </div>

          <div class="row g-3 mt-1">
            <!-- Required final -->
            <div class="col-12">
              <div class="need-card" id="needCard">
                <div class="need-inner">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                      <div class="grade-indicator bg-info text-dark">
                        <i class="bi bi-bullseye"></i>
                      </div>
                      <div>
                        <div class="small muted">Required Final Score for</div>
                        <div class="fw-bold h5 mb-0" id="goalLabel">A</div>
                      </div>
                    </div>
                    <div class="text-end">
                      <div class="need-number text-info" id="needFinal">—</div>
                      <div class="mini-progress mt-2" aria-hidden="true">
                        <div class="bar" id="needBar" style="width:0%"></div>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex align-items-center justify-content-between mt-2">
                    <small class="text-muted" id="needNote">Enter your marks and weights to see results.</small>
                    <span class="badge rounded-pill status-badge" id="statusChip">Waiting for input</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Chart -->
            <div class="col-12">
              <div class="chart-wrap">
                <canvas id="contribChart" aria-label="Contribution chart"></canvas>
              </div>
            </div>

            <!-- OVERALL -->
            <div class="col-12">
              <div class="overall-card">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="overall-sub mb-1">Overall (current)</div>
                    <div class="overall-number" id="overallBig">—</div>
                  </div>
                  <span id="overallGrade" class="overall-badge grade-c">—</span>
                </div>
                <div class="overall-progress mt-3">
                  <div class="bar" id="overallBar" style="width:0%"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ----------------------- Utilities ----------------------- */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];

    const gradeScale = {
      'A+': 90, 'A': 80, 'A-': 75,
      'B+': 70, 'B': 65, 'B-': 60,
      'C+': 55, 'C': 50, 'F': 0
    };

    function clampOneDec(el){
      let v = (el.value ?? '').replace(',', '.').trim();
      if (v === '') { el.dataset.num = ''; return null; }
      if (v.includes('.')) {
        const [a,b] = v.split('.');
        v = a + '.' + (b ? b.substring(0,1) : '');
      }
      if (!/^\d{1,3}(\.\d)?$/.test(v)) {
        const parsed = parseFloat(v);
        if (isNaN(parsed)) { el.dataset.num = ''; el.value=''; return null; }
        v = parsed.toString();
        if (v.includes('.')) {
          const [a,b] = v.split('.');
          v = a + '.' + (b ? b.substring(0,1) : '');
        }
      }
      let num = Math.max(0, Math.min(100, parseFloat(v)));
      const one = Math.round(num*10)/10;
      const s = one.toFixed(1);
      el.value = s.endsWith('.0') ? String(parseInt(s)) : s;
      el.dataset.num = String(one);
      return one;
    }
    function readNum(el){
      const v = el?.dataset?.num;
      if (v === undefined || v === '') return null;
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }
    function fmt2(n){
      if (n == null || isNaN(n)) return '—';
      return (Math.round(n*100)/100).toFixed(2);
    }

    /* ✨ animated number tween */
    function tweenNumber(el, to, opts={}){
      if (to==null || !isFinite(to)) { el.textContent = '—'; return; }
      const decimals = opts.decimals ?? 2;
      const dur = opts.duration ?? 700;
      const from = parseFloat(el.dataset.prev ?? el.textContent) || 0;
      const start = performance.now();
      function step(now){
        const t = Math.min(1, (now - start)/dur);
        const eased = t<.5 ? 2*t*t : -1+(4-2*t)*t; // easeInOutQuad
        const val = from + (to - from) * eased;
        el.textContent = val.toFixed(decimals) + (opts.suffix || '');
        if (t < 1) requestAnimationFrame(step);
        else el.dataset.prev = to;
      }
      requestAnimationFrame(step);
    }

    function updateWeightsUI(){
      const wMid = readNum($('#wMid')) ?? 0;
      const wAss = readNum($('#wAss')) ?? 0;
      const wFin = readNum($('#wFin')) ?? 0;
      const sum = wMid + wAss + wFin;
      const progress = $('#weightProgress');
      progress.style.width = Math.min(sum, 100) + '%';
      $('#weightTotal').textContent = Math.round(sum) + '%';

      // colors + subtle wiggle when off
      const bar = progress;
      if (Math.abs(sum - 100) < 0.1) {
        bar.style.background = 'linear-gradient(90deg, var(--success), #37d67a)';
      } else if (sum > 100) {
        bar.style.background = 'linear-gradient(90deg, var(--danger), #d9534f)';
        bar.classList.remove('wiggle'); void bar.offsetWidth; bar.classList.add('wiggle');
      } else {
        bar.style.background = 'linear-gradient(90deg, var(--brand-2), var(--brand))';
      }
      return Math.abs(sum - 100) < 0.1;
    }

    function toggleWeightInputs(disabled) {
      ['#wMid', '#wAss', '#wFin', '#wMidSel', '#wAssSel', '#wFinSel'].forEach(sel => {
        const el = $(sel);
        if (el) el.disabled = disabled;
      });
    }

    function saveToStorage(){
      const data = {
        wMid: $('#wMid').value, wAss: $('#wAss').value, wFin: $('#wFin').value,
        mMid: $('#mMid')?.value, mAss: $('#mAss')?.value, mFin: $('#mFin').value,
        mCoursework: $('#mCoursework').value,
        useIndividualMarks: $('#marksModeToggle').checked,
        goal: $('#goalGrade').value,
        coursePreset: $('#coursePreset').value
      };
      localStorage.setItem('ggc:v2', JSON.stringify(data));
    }
    function loadFromStorage(){
      const s = localStorage.getItem('ggc:v2');
      if (!s) return;
      try{
        const d = JSON.parse(s);
        if (d.wMid) $('#wMid').value = d.wMid;
        if (d.wAss) $('#wAss').value = d.wAss;
        if (d.wFin) $('#wFin').value = d.wFin;
        if (d.mMid) $('#mMid').value = d.mMid;
        if (d.mAss) $('#mAss').value = d.mAss;
        if (d.mFin) $('#mFin').value = d.mFin;
        if (d.mCoursework) $('#mCoursework').value = d.mCoursework;

        if (d.goal) $('#goalGrade').value = d.goal;
        if (d.coursePreset) { $('#coursePreset').value = d.coursePreset; toggleWeightInputs(d.coursePreset !== ''); }

        ['#wMid','#wAss','#wFin','#mMid','#mAss','#mFin','#mCoursework'].forEach(sel => { const el=$(sel); if(el) clampOneDec(el); });

        $('#marksModeToggle').checked = !!d.useIndividualMarks;
        setIndividualMarksVisible($('#marksModeToggle').checked);
      }catch(e){}
    }

    /* ----------- Grade helpers ----------- */
    function gradeFromPercent(p){
      if (p == null || isNaN(p)) return null;
      const entries = Object.entries(gradeScale).sort((a,b)=>b[1]-a[1]);
      for (const [g,th] of entries){ if (p >= th) return g; }
      return 'F';
    }
    function gradeClass(g){
      if (!g) return 'grade-c';
      if (g.startsWith('A')) return 'grade-a';
      if (g.startsWith('B')) return 'grade-b';
      if (g.startsWith('C')) return 'grade-c';
      return 'grade-f';
    }

    /* ----------------------- Calculation ----------------------- */
    let pie; // chart instance
    let centerLabel = '—';
    let lastLetter = null;
    let confettiCooldown = 0;

    function compute(){
      const wMid = readNum($('#wMid')) ?? 0;
      const wAss = readNum($('#wAss')) ?? 0;
      const wFin = readNum($('#wFin')) ?? 0;

      const useIndividualMarks = $('#marksModeToggle').checked;
      let mMid, mAss;
      if (useIndividualMarks) {
        mMid = readNum($('#mMid'));
        mAss = readNum($('#mAss'));
      } else {
        const mCoursework = readNum($('#mCoursework'));
        mMid = mCoursework;
        mAss = mCoursework;
      }
      const mFin = readNum($('#mFin'));

      const okWeights = updateWeightsUI();

      const cMid = (wMid * (mMid ?? 0)) / 100;
      const cAss = (wAss * (mAss ?? 0)) / 100;
      const cFin = (wFin * (mFin ?? 0)) / 100;
      const overall = cMid + cAss + cFin;

      const grade = $('#goalGrade').value;
      const targetOverall = gradeScale[grade] ?? 0;
      let neededFinalPct = null;
      let needNote = '';
      let status = 'Start entering values';

      const hasMarks = (mMid !== null || mAss !== null || mFin !== null);
      const hasWeights = okWeights;

      if (hasWeights && hasMarks){
        if (wFin <= 0.0001){
          neededFinalPct = null;
          needNote = 'Final weight is 0%. Goal depends only on coursework.';
          status = overall >= targetOverall ? 'Goal reached' : 'Final not used';
        } else {
          const required = ((targetOverall - (cMid + cAss)) / (wFin/100));
          neededFinalPct = required;

          if (!isFinite(required)){
            neededFinalPct = null;
            needNote = 'Enter marks and valid weights.';
            status = 'Incomplete';
          } else if (required <= 0){
            neededFinalPct = 0;
            needNote = 'You\'ve already secured this grade before the final.';
            status = 'Goal reached';
          } else if (required > 100){
            const maxOverall = cMid + cAss + (wFin*100)/100;
            needNote = `Even a perfect final only gets you to ~${fmt2(maxOverall)}%`;
            status = 'Unattainable';
          } else {
            needNote = 'Final mark needed to reach your grade.';
            status = 'On track';
          }
        }
      } else if (!hasWeights) {
        needNote = 'Adjust weights so they total 100%.';
        status = 'Fix weights';
      } else {
        needNote = 'Enter your marks to see results.';
        status = 'Enter marks';
      }

      return {
        wMid,wAss,wFin, mMid,mAss,mFin,
        cMid,cAss,cFin, overall, okWeights,
        grade, targetOverall, neededFinalPct, status, needNote,
        hasValidData: hasWeights && hasMarks
      };
    }

    function render(state){
      $('#resultCard').classList.toggle('inactive', !state.hasValidData);
      $('#goalLabel').textContent = state.grade;

      // Required Final: number (animated), note, status, progress, and state accent
      const needFinalEl = $('#needFinal');
      if (state.neededFinalPct==null || !isFinite(state.neededFinalPct)) {
        needFinalEl.textContent = '—';
        needFinalEl.dataset.prev = 0;
      } else {
        // allow values > 100% in the display
        const val = Math.max(0, state.neededFinalPct);
        tweenNumber(needFinalEl, val, {decimals:2, duration:700, suffix:'%'});
      }
      $('#needNote').textContent = state.needNote;
      const needBar = $('#needBar');
      const needCard = $('#needCard');
      needCard.className = 'need-card'; // reset
      const needPct = (state.neededFinalPct!=null && isFinite(state.neededFinalPct)) ? Math.max(0, Math.min(100, state.neededFinalPct)) : 0;
      needBar.style.width = needPct + '%';

      // Status chip + color accents
      const chip = $('#statusChip');
      chip.textContent = state.status;
      chip.className = 'badge rounded-pill status-badge';
      needFinalEl.className = 'need-number';

      if (state.status === 'Goal reached'){
        chip.classList.add('bg-success','text-dark','pop'); setTimeout(()=>chip.classList.remove('pop'), 250);
        needFinalEl.classList.add('text-success');
        needCard.classList.add('need-ok');
        fireConfetti();
      }
      else if (state.status === 'On track'){
        chip.classList.add('bg-info','text-dark','pop'); setTimeout(()=>chip.classList.remove('pop'), 250);
        needFinalEl.classList.add('text-info');
        needCard.classList.add('need-info');
      }
      else if (state.status === 'Unattainable'){
        chip.classList.add('bg-danger','pop'); setTimeout(()=>chip.classList.remove('pop'), 250);
        needFinalEl.classList.add('text-danger');
        needCard.classList.add('need-bad');
      }
      else if (state.status === 'Fix weights' || state.status === 'Enter marks' || state.status === 'Incomplete'){
        chip.classList.add('bg-warning','text-dark');
        needFinalEl.classList.add('text-warning');
        needCard.classList.add('need-warn');
      }
      else{
        chip.classList.add('bg-secondary');
        needFinalEl.classList.add('text-info');
      }

      // Chart (current)
      if (state.hasValidData) {
        const cMid = (state.wMid * (state.mMid ?? 0)) / 100;
        const cAss = (state.wAss * (state.mAss ?? 0)) / 100;
        const cFin = (state.wFin * (state.mFin ?? 0)) / 100;
        centerLabel = 'Contribution';
        updateChart([Math.max(0,cMid), Math.max(0,cAss), Math.max(0,cFin)]);
      } else {
        centerLabel = '—';
        updateChart([0, 0, 0]);
      }

      // OVERALL UI with grade + progress
      const overallEl = $('#overallBig');
      if (state.hasValidData && isFinite(state.overall)) {
        tweenNumber(overallEl, state.overall, {decimals:2});
      } else {
        overallEl.textContent = '—'; overallEl.dataset.prev = 0;
      }
      const pct = (state.hasValidData && isFinite(state.overall)) ? Math.max(0, Math.min(100, state.overall)) : 0;
      $('#overallBar').style.width = pct + '%';

      const letter = (state.hasValidData && isFinite(state.overall)) ? gradeFromPercent(state.overall) : null;
      const gradeEl = $('#overallGrade');
      const prevLetter = lastLetter;
      gradeEl.textContent = letter ?? '—';
      gradeEl.className = 'overall-badge ' + (letter ? gradeClass(letter) : 'grade-c');
      if (letter && prevLetter && letter !== prevLetter){
        gradeEl.classList.add('sparkle');
        setTimeout(()=>gradeEl.classList.remove('sparkle'), 900);
      }
      lastLetter = letter;
    }

    function computeAndRender(){
      const s = compute();
      render(s);
      saveToStorage();
    }

    /* ----------------------- Chart (Doughnut + center label) ----------------------- */
    const centerTextPlugin = {
      id:'centerText',
      afterDraw(chart, args, opts){
        const {ctx, chartArea:{width, height}} = chart;
        ctx.save();
        ctx.font = '600 14px "Segoe UI", system-ui';
        ctx.fillStyle = '#a8b5c3';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(centerLabel, chart.getDatasetMeta(0).data[0].x, chart.getDatasetMeta(0).data[0].y - 8);

        // total points sum for quick glance
        const sum = chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
        ctx.font = '800 18px "Segoe UI", system-ui';
        ctx.fillStyle = '#e8eef6';
        ctx.fillText(sum ? sum.toFixed(1) : '0.0', chart.getDatasetMeta(0).data[0].x, chart.getDatasetMeta(0).data[0].y + 12);
        ctx.restore();
      }
    };

    function initChart(){
      const ctx = document.getElementById('contribChart');
      Chart.register(centerTextPlugin);
      pie = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Midterm','Assignment','Final'],
          datasets: [{ 
            data: [0,0,0],
            /* ✨ nicer palette */
            backgroundColor: ['#e76f51', '#f4a261', '#2a9d8f'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '62%',
          layout: { padding: 8 },
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 14, color: '#e8eef6' } },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${fmt2(ctx.parsed)} pts` } }
          },
          animation: {
            animateRotate: true, animateScale: true,
            duration: 650, easing: 'easeOutQuart'
          }
        }
      });
    }
    function updateChart(arr){
      if (!pie) return;
      pie.data.datasets[0].data = arr;
      pie.update();
    }

    /* ----------------------- Visibility helpers ----------------------- */
    function setIndividualMarksVisible(on){
      $('#courseworkWrap').style.display = on ? 'none' : '';
      $('#midWrap').style.display = on ? '' : 'none';
      $('#assWrap').style.display = on ? '' : 'none';
    }

    /* ----------------------- Events ----------------------- */
    function bindNumericOneDec(selector){
      $$(selector).forEach(el=>{
        el.addEventListener('input', ()=>{ clampOneDec(el); computeAndRender(); });
        el.addEventListener('change', ()=>{ clampOneDec(el); computeAndRender(); });
        el.addEventListener('blur',  ()=>{ clampOneDec(el); computeAndRender(); });
      });
    }
    function bindWeightPreset(selId, inputId){
      $(selId).addEventListener('change', (e)=>{
        const v = e.target.value;
        if (v !== '') {
          const input = $(inputId);
          input.value = v;
          clampOneDec(input);
          computeAndRender();
        }
      });
    }
    function bindCoursePresets(){
      $('#coursePreset').addEventListener('change', (e)=>{
        const v = e.target.value;
        toggleWeightInputs(v !== '');
        if (v==='SE' || v==='AI'){ $('#wMid').value='24'; $('#wAss').value='36'; $('#wFin').value='40'; }
        else if (v==='DSA'){ $('#wMid').value='20'; $('#wAss').value='50'; $('#wFin').value='30'; }
        else if (v===''){ $('#wMid').value=''; $('#wAss').value=''; $('#wFin').value=''; }
        ['#wMidSel','#wAssSel','#wFinSel'].forEach(sel => $(sel).value = '');
        clampOneDec($('#wMid')); clampOneDec($('#wAss')); clampOneDec($('#wFin'));
        computeAndRender();
      });
    }
    function bindMarkToggle(){
      $('#marksModeToggle').addEventListener('change', (e)=>{
        const on = e.target.checked;
        setIndividualMarksVisible(on);
        if (on) {
          const coursework = readNum($('#mCoursework'));
          if (coursework !== null) {
            $('#mMid').value = $('#mCoursework').value;
            $('#mAss').value = $('#mCoursework').value;
            clampOneDec($('#mMid')); clampOneDec($('#mAss'));
          }
        }
        computeAndRender();
      });
    }

    /* ✨ Reveal-on-scroll */
    function initReveals(){
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if (entry.isIntersecting) entry.target.classList.add('visible');
        });
      },{threshold:.12});
      $$('.reveal').forEach(el=>io.observe(el));
    }

    /* ✨ Tilt cards */
    function initTilt(){
      const els = $$('.tilt');
      els.forEach(el=>{
        el.addEventListener('pointermove', (e)=>{
          const r = el.getBoundingClientRect();
          const x = (e.clientX - r.left) / r.width;
          const y = (e.clientY - r.top) / r.height;
          const rx = (y - .5) * -6; // rotateX
          const ry = (x - .5) * 8;  // rotateY
          el.style.setProperty('--rx', rx+'deg');
          el.style.setProperty('--ry', ry+'deg');
          el.style.setProperty('--ty', '-2px');
        });
        el.addEventListener('pointerleave', ()=>{
          el.style.setProperty('--rx', '0deg');
          el.style.setProperty('--ry', '0deg');
          el.style.setProperty('--ty', '0');
        });
      });
    }

    /* ✨ Confetti (fires on goal reached, throttled) */
    function fireConfetti(){
      const now = Date.now();
      if (now - confettiCooldown < 1200) return; // throttle
      confettiCooldown = now;

      const colors = ['#37d67a','#4ba3ff','#83ffe9','#f4a261','#e76f51','#b8e1ff'];
      for (let i=0;i<80;i++){
        const d = document.createElement('div');
        d.className = 'confetti';
        d.style.background = colors[i % colors.length];
        d.style.left = (Math.random()*100)+'vw';
        d.style.setProperty('--x', (Math.random()*40 - 20)+'vw');
        d.style.setProperty('--y', (60 + Math.random()*20)+'vh');
        d.style.setProperty('--r', (Math.random()*2 + .5)+'turn');
        d.style.setProperty('--t', (800 + Math.random()*900)+'ms');
        document.body.appendChild(d);
        setTimeout(()=>d.remove(), 1800);
      }
    }

    /* ----------------------- Init ----------------------- */
    window.addEventListener('DOMContentLoaded', ()=>{
      bindNumericOneDec('#wMid,#wAss,#wFin,#mMid,#mAss,#mFin,#mCoursework');
      bindWeightPreset('#wMidSel','#wMid');
      bindWeightPreset('#wAssSel','#wAss');
      bindWeightPreset('#wFinSel','#wFin');
      bindCoursePresets();
      bindMarkToggle();

      $('#goalGrade').addEventListener('change', computeAndRender);

      loadFromStorage();

      if (!$('#wMid').value && !$('#wAss').value && !$('#wFin').value && $('#coursePreset').value === ''){
        $('#wMid').value = '24'; $('#wAss').value = '36'; $('#wFin').value = '40';
        $('#mCoursework').value = '96';
        clampOneDec($('#wMid')); clampOneDec($('#wAss')); clampOneDec($('#wFin'));
        clampOneDec($('#mCoursework'));
      }

      setIndividualMarksVisible($('#marksModeToggle').checked);

      initChart();
      initReveals();
      initTilt();
      computeAndRender();
    });
  </script>
</body>
</html>
